version: "2.4"

services:
  influxdb:
    image: influxdb:2
    ports:
      - "8086:8086"
    volumes:
      - ./data:/var/lib/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_ADMIN_USER}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_TOKEN}
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  collector:
    build: ./collector
    environment:
      - INVERTER_IP=${INVERTER_IP}
      - INVERTER_CI_IP=${INVERTER_CI_IP}
      - KSEM_IP=${KSEM_IP}
      - POLL_INTERVAL=${POLL_INTERVAL}
      - OMIE_ENABLED=${OMIE_ENABLED}
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_ORG=${INFLUXDB_ORG}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET}
    depends_on:
      influxdb:
        condition: service_healthy
    restart: unless-stopped

  dashboard:
    build: ./dashboard
    ports:
      - "5000:5000"
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_ORG=${INFLUXDB_ORG}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET}
      - ELECTRICITY_COST=${ELECTRICITY_COST}
      - INJECTION_PRICE=${INJECTION_PRICE}
      - CO2_FACTOR=${CO2_FACTOR}
    volumes:
      - ./pricing.json:/app/pricing.json
      - ./offers.json:/app/offers.json
      - invoice-data:/app/invoices
    depends_on:
      influxdb:
        condition: service_healthy
    restart: unless-stopped

volumes:
  invoice-data:
