{% extends "base.html" %}

{% block title %}Comparador d'Ofertes{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
{% endblock %}

{% block header_right %}
<span>Comparador d'Ofertes 3.0TD</span>
{% endblock %}

{% block content %}

<!-- Data quality warning -->
{% if d.low_data %}
<div class="flash-error" style="margin-bottom: 1.5rem;">
    <strong>Poques dades disponibles.</strong>
    El col&middot;lector nom&eacute;s t&eacute; {{ d.actual.hours_data }} hores de dades reals
    (cal m&iacute;nim 1 setmana per resultats fiables).
    Pots introduir els valors de consum manualment m&eacute;s avall.
</div>
{% endif %}

<!-- Step 1: Period timeline -->
<div class="section">
    <div class="section-header">
        <span class="icon">&#9312;</span>
        <h2>Horaris 3.0TD &mdash; Com es distribueix el consum</h2>
    </div>
    <p class="section-help">Cada hora del dia pertany a un per&iacute;ode (P1-P6).
        El preu varia seg&uacute;ns el per&iacute;ode &mdash; P1 &eacute;s el m&eacute;s car, P6 el m&eacute;s barat.</p>

    <div class="timeline-container">
        <div class="timeline-row">
            <span class="timeline-label">Dl-Dv</span>
            <div class="period-timeline" id="timeline-weekday"></div>
        </div>
        <div class="timeline-row">
            <span class="timeline-label">Dissabte</span>
            <div class="period-timeline" id="timeline-saturday"></div>
        </div>
        <div class="timeline-row">
            <span class="timeline-label">Diumenge</span>
            <div class="period-timeline" id="timeline-sunday"></div>
        </div>
        <div class="timeline-legend" id="timeline-legend"></div>
    </div>
</div>

<div class="martini-stripe-thin"></div>

<!-- Step 2: Offers -->
<div class="section">
    <div class="section-header">
        <span class="icon">&#9313;</span>
        <h2>Ofertes &mdash; Afegeix les propostes que vols comparar</h2>
    </div>
    <p class="section-help">El contracte actual est&agrave; precarregat. Afegeix les ofertes que has rebut per veure la comparativa.</p>

    <div class="offers-grid" id="offers-grid">
        <!-- Offer cards generated by JS -->
    </div>

    <button class="btn btn-primary" id="btn-add-offer" style="margin-top: 1rem;">+ Afegir oferta</button>

    <!-- Offer form modal -->
    <div class="offer-modal" id="offer-modal" style="display:none;">
        <div class="offer-modal-content">
            <h3 id="modal-title">Nova oferta</h3>
            <input type="hidden" id="form-offer-id">

            <div class="form-row">
                <div class="form-field">
                    <label for="form-supplier">Comercialitzadora</label>
                    <input type="text" id="form-supplier" placeholder="Ex: Holaluz, Naturgy...">
                </div>
                <div class="form-field">
                    <label for="form-name">Nom de la tarifa</label>
                    <input type="text" id="form-name" placeholder="Ex: Tarifa plana 2026">
                </div>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label for="form-type">Tipus</label>
                    <select id="form-type">
                        <option value="fixed">Preu fix (EUR/kWh per per&iacute;ode)</option>
                        <option value="indexed">Indexada (OMIE + marge)</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="form-discount">Descompte sobre energia (%)</label>
                    <input type="number" id="form-discount" value="0" step="0.1" min="0" max="100">
                </div>
            </div>

            <!-- Fixed: energy rates -->
            <div id="fixed-rates-section">
                <p class="form-hint">Introdueix el preu d'energia. Si &eacute;s una tarifa plana (preu &uacute;nic),
                    escriu-lo i prem &laquo;Aplicar a tots&raquo;. Si cada per&iacute;ode t&eacute; un preu diferent,
                    omple'ls individualment.</p>
                <div class="form-row" style="align-items: flex-end;">
                    <div class="form-field" style="flex: 2;">
                        <label for="form-flat-rate">Preu &uacute;nic (EUR/kWh)</label>
                        <input type="number" id="form-flat-rate" step="0.000001" min="0" placeholder="0.154">
                    </div>
                    <button class="btn btn-sm" id="btn-apply-flat">Aplicar a tots</button>
                </div>
                <div class="form-row form-rates" id="form-period-rates">
                    <div class="form-field"><label>P1</label><input type="number" id="form-rate-P1" step="0.000001" min="0"></div>
                    <div class="form-field"><label>P2</label><input type="number" id="form-rate-P2" step="0.000001" min="0"></div>
                    <div class="form-field"><label>P3</label><input type="number" id="form-rate-P3" step="0.000001" min="0"></div>
                    <div class="form-field"><label>P4</label><input type="number" id="form-rate-P4" step="0.000001" min="0"></div>
                    <div class="form-field"><label>P5</label><input type="number" id="form-rate-P5" step="0.000001" min="0"></div>
                    <div class="form-field"><label>P6</label><input type="number" id="form-rate-P6" step="0.000001" min="0"></div>
                </div>
            </div>

            <!-- Indexed: margin -->
            <div id="indexed-margin-section" style="display:none;">
                <p class="form-hint">Per tarifes indexades, el cost d'energia &eacute;s:
                    preu OMIE + peatges + c&agrave;rrecs + marge de la comercialitzadora.</p>
                <div class="form-row">
                    <div class="form-field">
                        <label for="form-margin">Marge comercialitzadora (EUR/kWh)</label>
                        <input type="number" id="form-margin" step="0.0001" min="0" value="0.005" placeholder="0.005">
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label for="form-injection">Compensaci&oacute; excedents (EUR/kWh)</label>
                    <input type="number" id="form-injection" step="0.001" min="0" value="0.05">
                </div>
                <div class="form-field">
                    <label for="form-fixed-charges">C&agrave;rregues fixes (EUR/dia)</label>
                    <input type="number" id="form-fixed-charges" step="0.001" min="0" value="1.659">
                </div>
            </div>

            <details class="form-advanced">
                <summary>Pot&egrave;ncia contractada i preus de pot&egrave;ncia (avan√ßat)</summary>
                <p class="form-hint" style="margin-top:0.5rem;">Normalment s&oacute;n regulats i iguals per totes
                    les comercialitzadores. Nom&eacute;s cal canviar-los si l'oferta modifica la pot&egrave;ncia contractada.</p>
                <div class="form-row form-rates">
                    <div class="form-field"><label>P1 kW</label><input type="number" id="form-power-P1" step="0.1" value="69"></div>
                    <div class="form-field"><label>P2 kW</label><input type="number" id="form-power-P2" step="0.1" value="69"></div>
                    <div class="form-field"><label>P3 kW</label><input type="number" id="form-power-P3" step="0.1" value="69"></div>
                    <div class="form-field"><label>P4 kW</label><input type="number" id="form-power-P4" step="0.1" value="69"></div>
                    <div class="form-field"><label>P5 kW</label><input type="number" id="form-power-P5" step="0.1" value="69"></div>
                    <div class="form-field"><label>P6 kW</label><input type="number" id="form-power-P6" step="0.1" value="69"></div>
                </div>
                <div class="form-row form-rates" style="margin-top: 0.5rem;">
                    <div class="form-field"><label>P1 EUR/kW/dia</label><input type="number" id="form-pcharge-P1" step="0.000001" value="0.060903"></div>
                    <div class="form-field"><label>P2 EUR/kW/dia</label><input type="number" id="form-pcharge-P2" step="0.000001" value="0.036886"></div>
                    <div class="form-field"><label>P3 EUR/kW/dia</label><input type="number" id="form-pcharge-P3" step="0.000001" value="0.017573"></div>
                    <div class="form-field"><label>P4 EUR/kW/dia</label><input type="number" id="form-pcharge-P4" step="0.000001" value="0.017573"></div>
                    <div class="form-field"><label>P5 EUR/kW/dia</label><input type="number" id="form-pcharge-P5" step="0.000001" value="0.017573"></div>
                    <div class="form-field"><label>P6 EUR/kW/dia</label><input type="number" id="form-pcharge-P6" step="0.000001" value="0.006065"></div>
                </div>
            </details>

            <div class="form-actions">
                <button class="btn" id="btn-cancel-offer">Cancel&middot;lar</button>
                <button class="btn btn-primary" id="btn-save-offer">Desar oferta</button>
            </div>
        </div>
    </div>
</div>

<div class="martini-stripe-thin"></div>

<!-- Step 3: Scenario -->
<div class="section">
    <div class="section-header">
        <span class="icon">&#9314;</span>
        <h2>Escenari de Consum &mdash; Ajusta els par&agrave;metres</h2>
    </div>
    <p class="section-help">Introdueix el consum mensual estimat i com es distribueix entre per&iacute;odes.
        Pots fer servir les dades reals o provar escenaris predefinits.</p>

    <div class="scenario-inputs">
        <div class="scenario-field">
            <label for="input-total-kwh">Consum mensual (kWh)</label>
            <input type="number" id="input-total-kwh" step="1" min="0">
        </div>
        <div class="scenario-field">
            <label for="input-export-kwh">Exportaci&oacute; mensual (kWh)</label>
            <input type="number" id="input-export-kwh" step="1" min="0">
        </div>
        <div class="scenario-field">
            <label for="input-days">Dies de facturaci&oacute;</label>
            <input type="number" id="input-days" step="1" min="1" max="365" value="30">
        </div>
    </div>

    <div class="scenario-tabs">
        <button class="scenario-tab active" data-scenario="real" title="Distribuci&oacute; real segons InfluxDB">Real</button>
        <button class="scenario-tab" data-scenario="diurn" title="Perfil de consum principalment di&uuml;rn">Di&uuml;rn</button>
        <button class="scenario-tab" data-scenario="nocturn" title="Perfil de consum principalment nocturn">Nocturn</button>
        <button class="scenario-tab" data-scenario="uniforme" title="Distribuci&oacute; proporcional a les hores de cada per&iacute;ode">Uniforme</button>
        <button class="scenario-tab" data-scenario="personalitzat" title="Ajusta manualment cada per&iacute;ode">Personalitzat</button>
    </div>

    <div class="slider-group-container" id="sliders-container">
        <!-- Sliders generated by JS -->
    </div>
</div>

<div class="martini-stripe-thin"></div>

<!-- Step 4: Results -->
<div class="section">
    <div class="section-header">
        <span class="icon">&#9315;</span>
        <h2>Resultat &mdash; Comparativa de costos</h2>
    </div>

    <div id="no-comparison-msg" class="empty-state" style="display:none;">
        <p><strong>Afegeix com a m&iacute;nim una oferta m&eacute;s</strong> per veure la comparativa.</p>
        <p style="color: var(--muted); margin-top: 0.5rem;">
            Prem el bot&oacute; &laquo;+ Afegir oferta&raquo; m&eacute;s amunt.</p>
    </div>

    <div id="comparison-results">
        <div class="chart-wrap">
            <h3>Cost net mensual per oferta (EUR)</h3>
            <canvas id="chart-comparison"></canvas>
        </div>

        <div class="comparison-table-wrap">
            <table class="comparison-table" id="comparison-table">
                <thead id="comparison-thead"></thead>
                <tbody id="comparison-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Sensitivity note -->
<div class="section">
    <div class="sensitivity-note" id="sensitivity-note"></div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const comparadorData = {{ d|tojson }};
</script>
<script src="{{ url_for('static', filename='js/comparador.js') }}"></script>
{% endblock %}
