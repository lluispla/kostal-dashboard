{% extends "base.html" %}
{% block title %}Anàlisi — {{ data.invoice.filename }}{% endblock %}

{% block header_right %}
<span>{{ data.invoice.filename }}
    {% if data.invoice.billing_start and data.invoice.billing_end %}
    &mdash; {{ data.invoice.billing_start }} a {{ data.invoice.billing_end }}
    {% endif %}
</span>
{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
{% endblock %}

{% block content %}
<a href="{{ url_for('factures') }}" class="back-link">&larr; Tornar a factures</a>

<!-- KPI Cards -->
<div class="analysis-grid">
    <div class="kpi-card">
        <div class="label">Total factura</div>
        <div class="value val-red">{{ "%.2f"|format(data.invoice.total or data.total_estimate) }} <span class="unit">&euro;</span></div>
    </div>
    <div class="kpi-card">
        <div class="label">Consum total</div>
        <div class="value val-blue">{{ "%.0f"|format(data.invoice.total_consumption_kwh) }} <span class="unit">kWh</span></div>
    </div>
    <div class="kpi-card">
        <div class="label">Cost efectiu</div>
        <div class="value val-navy">{{ "%.4f"|format(data.effective_eur_kwh) }} <span class="unit">&euro;/kWh</span></div>
    </div>
    <div class="kpi-card">
        <div class="label">Compensació injecció</div>
        <div class="value val-green">{{ "%.2f"|format(data.injection_compensation) }} <span class="unit">&euro;</span></div>
    </div>
</div>

<!-- Consumption breakdown -->
<div class="analysis-section">
    <h2>Consum per període</h2>
    {% if data.invoice.consumption %}
    <div style="max-width: 600px; margin: 0 auto 1.5rem;">
        <canvas id="consumptionChart"></canvas>
    </div>
    <table class="analysis-table">
        <thead>
            <tr>
                <th>Període</th>
                <th style="text-align:right">kWh</th>
                <th style="text-align:right">Tarifa &euro;/kWh</th>
                <th style="text-align:right">Cost &euro;</th>
            </tr>
        </thead>
        <tbody>
            {% for p in ['P1','P2','P3','P4','P5','P6'] %}
            {% if p in data.invoice.consumption %}
            <tr>
                <td>{{ p }}</td>
                <td class="num">{{ "%.1f"|format(data.invoice.consumption[p]) }}</td>
                <td class="num">{{ "%.6f"|format(data.invoice.rates.get(p, data.fixed_rate)) }}</td>
                <td class="num">{{ "%.2f"|format(data.invoice.consumption[p] * data.invoice.rates.get(p, data.fixed_rate)) }}</td>
            </tr>
            {% endif %}
            {% endfor %}
            <tr class="total">
                <td>Total</td>
                <td class="num">{{ "%.1f"|format(data.invoice.total_consumption_kwh) }}</td>
                <td class="num">&mdash;</td>
                <td class="num">{{ "%.2f"|format(data.fixed_energy_cost) }}</td>
            </tr>
        </tbody>
    </table>
    {% else %}
    <p style="color: var(--muted);">No s'han pogut extreure dades de consum per període del PDF.</p>
    {% endif %}
</div>

<!-- Cost breakdown -->
<div class="analysis-section">
    <h2>Desglossament de costos (estimació)</h2>
    <table class="analysis-table">
        <tbody>
            <tr><td>Energia</td><td class="num">{{ "%.2f"|format(data.fixed_energy_cost) }} &euro;</td></tr>
            <tr><td>Potència contractada</td><td class="num">{{ "%.2f"|format(data.power_cost_estimate) }} &euro;</td></tr>
            <tr><td>Impost electricitat (5.11%)</td><td class="num">{{ "%.2f"|format(data.electricity_tax_estimate) }} &euro;</td></tr>
            <tr><td>Lloguer equips + bo social</td><td class="num">{{ "%.2f"|format(data.fixed_charges_estimate) }} &euro;</td></tr>
            <tr><td>IVA (21%)</td><td class="num">{{ "%.2f"|format(data.iva_estimate) }} &euro;</td></tr>
            <tr class="total"><td>Total estimat</td><td class="num">{{ "%.2f"|format(data.total_estimate) }} &euro;</td></tr>
        </tbody>
    </table>
</div>

<!-- OMIE comparison -->
<div class="analysis-section">
    <h2>Comparació tarifa fixa vs mercat OMIE</h2>
    {% if data.omie_avg_eur_kwh is not none %}
    <div class="comparison-grid">
        <div class="comp-card fixed">
            <div class="comp-label">Tarifa fixa</div>
            <div class="comp-value" style="color: var(--blue);">{{ "%.2f"|format(data.fixed_energy_cost) }} &euro;</div>
            <div class="comp-rate">{{ "%.4f"|format(data.fixed_rate) }} &euro;/kWh</div>
        </div>
        <div class="comp-card indexed">
            <div class="comp-label">Tarifa indexada OMIE</div>
            <div class="comp-value" style="color: var(--red);">{{ "%.2f"|format(data.omie_energy_cost) }} &euro;</div>
            <div class="comp-rate">{{ "%.4f"|format(data.omie_avg_eur_kwh) }} &euro;/kWh (mitjana)</div>
        </div>
    </div>
    {% if data.savings_vs_omie is not none %}
    <div style="text-align: center; margin-top: 1.5rem;">
        {% if data.savings_vs_omie > 0 %}
        <p style="font-size: 1.1rem; color: var(--red);">La tarifa fixa ha costat <strong>{{ "%.2f"|format(data.savings_vs_omie) }} &euro; més</strong> que l'indexada</p>
        {% else %}
        <p style="font-size: 1.1rem; color: var(--green);">La tarifa fixa ha estalviat <strong>{{ "%.2f"|format(data.savings_vs_omie|abs) }} &euro;</strong> respecte l'indexada</p>
        {% endif %}
    </div>
    {% endif %}
    {% else %}
    <p style="color: var(--muted);">No hi ha dades OMIE disponibles per al període de facturació.</p>
    {% endif %}
</div>

<!-- Suggestions -->
{% if data.suggestions %}
<div class="analysis-section">
    <h2>Suggeriments d'optimització</h2>
    {% for s in data.suggestions %}
    <div class="suggestion">{{ s }}</div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if data.invoice.consumption %}
<script>
    const periods = {{ data.invoice.consumption.keys()|list|tojson }};
    const values = {{ data.invoice.consumption.values()|list|tojson }};

    new Chart(document.getElementById('consumptionChart'), {
        type: 'bar',
        data: {
            labels: periods,
            datasets: [{
                label: 'kWh',
                data: values,
                backgroundColor: ['#E63946', '#0C4DA2', '#002B5B', '#1a6bba', '#4a8fd4', '#C0C0C0'],
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Consum per període (kWh)', color: '#6c757d', font: { size: 14 } }
            },
            scales: {
                x: { ticks: { color: '#6c757d' }, grid: { display: false } },
                y: { ticks: { color: '#6c757d' }, grid: { color: '#f0f0f0' } }
            }
        }
    });
</script>
{% endif %}
{% endblock %}
